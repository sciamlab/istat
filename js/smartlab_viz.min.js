var DEBUG=!1,mouse={x:0,y:0},appConstants={TRANSLATE_0:-1200,TRANSLATE_1:3700,SCALE:5E3},headerH=$("header").height(),WIDTH,HEIGHT,CANVAS_W,CANVAS_H;768<$("main").width()?(WIDTH=$("main").width(),HEIGHT=$("main").height()):(WIDTH=$("main").width(),HEIGHT=200);var offset=$(".container2").offset();CANVAS_W=offset.left;CANVAS_H=offset.top;var geons={},ISTAT_PARAM={Anno:2001};
geons.geoConfig=function(){this.TRANSLATE_0=appConstants.TRANSLATE_0;this.TRANSLATE_1=appConstants.TRANSLATE_1;this.SCALE=appConstants.SCALE;this.mercator=d3.geo.mercator();this.path=d3.geo.path().projection(this.mercator);this.setupGeo=function(){var a=this.mercator.translate();a[0]=this.TRANSLATE_0;a[1]=this.TRANSLATE_1;this.mercator.translate(a);this.mercator.scale(this.SCALE)}};geo=new geons.geoConfig;var cont=document.getElementById("3dcontainer");Detector.webgl||Detector.addGetWebGLMessage();
geo.setupGeo();var translate=geo.mercator.translate(),scene,controls,renderer,camera;projector={};var keyboard=new THREEx.KeyboardState,regions=new THREE.Object3D;regions.name="regions";
var rotSpeed=.02,datasets=[{dataset_file:"abitanti",label_it:"Abitanti",label_en:"Population"},{dataset_file:"imprese",label_it:"Quantit\u00e0 Imprese",label_en:"Nr. of companies"},{dataset_file:"assunzioni",label_it:"Propensione Assunzione",label_en:"Propensity to hire"},{dataset_file:"istruz_giovani",label_it:"Livello Istruzione 15-19 anni",label_en:"Education level 15-19 years"},{dataset_file:"criminalita_giovani",label_it:"Tasso criminalit\u00e0 giovanile",label_en:"Youth crime rate"},{dataset_file:"suicidi",
label_it:"Tasso Suicidi",label_en:"Suicide rate"},{dataset_file:"tumori",label_it:"Tasso mortalit\u00e0 tumori",label_en:"Cancer mortality rate per 100,000 population"}],labels={lbl_titleselect_it:"Cosa ti interessa vedere?",lbl_titleselect_en:"What you want compare?",lbl_titleslider_it:"Cosa \u00e8 pi\u00f9 importante?",lbl_titleslider_en:"What is more relevant?",lbl_titleshare_it:"Condividi!",lbl_titleshare_en:"Share!",lbl_title_it:"#ildatotratto visualizzazione indicatori regionali 3D #istat #datachallenge",
lbl_title_en:"#ildatotratto 3D regional statistical indicators visualization #istat #datachallenge",lbl_head_it:"regioni/<span class='gray'>imprese</span>/indicatori",lbl_head_en:"regions/<span class='gray'>corporates</span>/indicators"},urlParams;(window.onpopstate=function(){var a,b=/\+/g,d=/([^&=]+)=?([^&]*)/g,f=window.location.search.substring(1);for(urlParams={};a=d.exec(f);)urlParams[decodeURIComponent(a[1].replace(b," "))]=decodeURIComponent(a[2].replace(b," "))})();
for(var h=""==urlParams.h||null==urlParams.h?"abitanti":urlParams.h,c=""==urlParams.c||null==urlParams.c?"assunzioni":urlParams.c,g=""==urlParams.g||null==urlParams.g?"regioni":urlParams.g,hwc=""==urlParams.hwc||null==urlParams.hwc?"0.5":urlParams.hwc,l=""==urlParams.l||null==urlParams.l?"it":urlParams.l,dsc=0;dsc<datasets.length;dsc++)$("#statchooserH").append(new Option(datasets[dsc]["label_"+l],datasets[dsc].dataset_file)),$("#statchooserC").append(new Option(datasets[dsc]["label_"+l],datasets[dsc].dataset_file));
document.title=labels["lbl_title_"+l];$("#titleselect").text(labels["lbl_titleselect_"+l]);$("#titleslider").text(labels["lbl_titleslider_"+l]);$("#titleshare").text(labels["lbl_titleshare_"+l]);$("#subtitle").html(labels["lbl_head_"+l]);$("#aboutlink").attr("href","about_"+l+".html");$("#statchooserH").val(h);$("#statchooserC").val(c);$("#picklang").val(l);
var geojson,dataset,dataset_file,color_prop,height_prop,color_scaling_factor,height_scaling_factor,color_,height_label,color_unit,height_unit,title,description,color_weight=.5,height_weight=.5,color_sum=0,height_sum=0;
function draw3DStat(a,b,d){height_sum=color_sum=0;jQuery.getJSON("data/"+b+".json",function(b,v,x){datasetH=b;height_prop=datasetH.dim_prop;height_scaling_factor=datasetH.dim_scaling_factor;height_label=datasetH["dim_label_"+l];height_polarity=parseInt(datasetH.dim_polarity);height_unit=datasetH.dim_unit;$("#stat-dimhigh").html(height_label);$(".label-dim-high").html(height_label);for(var k=0;k<datasetH.data.length;k++)height_sum+=parseFloat(datasetH.data[k][height_prop]);DEBUG&&(console.log("height_prop: "+
height_prop),console.log("height_scaling_factor: "+height_scaling_factor),console.log("height_label: "+height_label),console.log("height_unit: "+height_unit),console.log("height_polarity: "+height_polarity),console.log("height_sum: "+height_sum));jQuery.getJSON("data/"+d+".json",function(b,d,f){datasetC=b;color_prop=datasetC.dim_prop;color_scaling_factor=datasetC.dim_scaling_factor;color_label=datasetC["dim_label_"+l];color_polarity=parseInt(datasetC.dim_polarity);color_unit=datasetC.dim_unit;$("#stat-dimcolor").html(color_label);
$(".label-dim-color").html(color_label);for(k=0;k<datasetC.data.length;k++)color_sum+=parseFloat(datasetC.data[k][color_prop]);DEBUG&&(console.log("color_prop: "+color_prop),console.log("color_scaling_factor: "+color_scaling_factor),console.log("color_label: "+color_label),console.log("color_unit: "+color_unit),console.log("color_polarity: "+color_polarity),console.log("color_sum: "+color_sum));jQuery.getJSON("geo/"+a+".json",function(a,b,d){function f(){requestAnimationFrame(f);renderer.render(scene,
camera);k()}function k(){keyboard.pressed("p")&&(console.log(" Printing... "),document.getElementById("canvas3d").toBlob(function(a){saveAs(a,"canvas_datotratto.png")}));keyboard.pressed("1")&&console.log(" Have a nice day! - 1");keyboard.pressed("2")&&console.log(" Have a nice day! - 2");controls.update()}geojson=a;initScene();initGUI();(function(){for(var a=[],b=[],d=[],f=0,k=-1,t=0,r=-1,p=0;p<geojson.features.length;p++){for(var e=geojson.features[p],s=geo.path(e),u=e.properties.id_regione,n,q,
m=0;m<datasetH.data.length;m++)if(datasetH.data[m].id_regione==u){datasetH.data[m].nome_regione=e.properties.nome_regione;n=datasetC.data[m][color_prop];q=datasetH.data[m][height_prop];normalized_color=n/color_sum*100*color_weight*color_polarity;normalized_height=q/height_sum*100*height_weight*height_polarity;datasetH.data[m].rank=parseInt(100*(normalized_color+normalized_height));datasetC.data[m].rank=parseInt(100*(normalized_color+normalized_height));break}e=transformSVGPathExposed(s);a.push(e);
e=parseInt(n*color_scaling_factor);e>f&&(f=e);if(e<k||-1==k)k=e;b.push(e);e=parseInt(q*height_scaling_factor);e>t&&(t=e);if(e<r||-1==r)r=e;d.push(e)}regionsort=jQuery.extend(!0,{},datasetH).data.sort(function(a,b){return a.rank<b.rank?1:a.rank>b.rank?-1:0});for(p=0;p<b.length;p++)n=jsgradient.generateGradient("#F02B07","#0476F0",b[p],k,f),n=new THREE.MeshLambertMaterial({color:n}),q=(d[p]-r)/(t-r)*100+50,e=a[p],s=new THREE.Vector3(100,q,-100),u=new THREE.Vector3(100,30,-100),m=[],m.push(s),m.push(u),
s=new THREE.SplineCurve3(m),q=e.extrude({amount:Math.round(q),bevelEnabled:!0,bevelThickness:20,bevelSize:10,bevelSegments:10,extrudePath:s}),q.castShadow=!0,n=new THREE.Mesh(q,n),n.castShadow=!0,n.name=geojson.features[p].properties.id_regione,regions.add(n);regions.castShadow=!0;scene.add(regions);updateStats(hwc)})();renderer.render(scene,camera);f()})})})}var CAMERA_X,CAMERA_Y,CAMERA_Z,INTERSECTED,mouse={x:0,y:0},hover_name,hover_color,hover_height;
function initDATGUI(){var a=new dat.GUI,b=a.addFolder("DATI");b.add(ISTAT_PARAM,"Anno",2001,2011).step(1).onChange(function(a){ISTAT_PARAM.anno=a});b.open();a=a.addFolder("Camera Position");a.add(camera.position,"x").listen();a.add(camera.position,"y").listen();a.add(camera.position,"z").listen()}function onDocumentMouseMove(a){a.preventDefault();mouse.x=(a.pageX-CANVAS_W)/WIDTH*2-1;mouse.y=-((a.pageY-CANVAS_H)/HEIGHT*2-1)}
function initGUI(){function a(){var d=this.scene.getObjectByName("regions").children,f=new THREE.Vector3(mouse.x,mouse.y,1);this.projector.unprojectVector(f,this.camera);d=(new THREE.Raycaster(this.camera.position,f.sub(this.camera.position).normalize())).intersectObjects(d);if(0<d.length)for(this.INTERSECTED=d[0].object,d=0;d<datasetH.data.length;d++){var f=datasetH.data[d],v=datasetC.data[d];if(f.id_regione==this.INTERSECTED.name){this.hover_name=f.nome_regione;this.hover_color=v[color_prop];this.hover_height=
f[height_prop];this.hover_rank=f.rank;break}}else this.INTERSECTED&&(this.hover_height=this.hover_color=this.hover_name=this.INTERSECTED=null);this.INTERSECTED?ddrivetip('<p><h4 style="font-family:Nilland,sans-serif;font-weight:900;">'+this.hover_name+"</h4>"+height_label+": "+this.hover_height+this.height_unit+"<br />"+color_label+": "+this.hover_color+this.color_unit+"<br />RANK:"+this.hover_rank+"</p>","rgba(231,231,231,0.8)",300):hideddrivetip();b(a)}var b=window.requestAnimationFrame;this.projector=
new THREE.Projector;document.addEventListener("mousemove",onDocumentMouseMove,!1);b(a)}function onWindowResize(){768<$("main").width()?(WIDTH=$("main").width(),HEIGHT=$("main").height()):(WIDTH=$("main").width(),HEIGHT=200);var a=$(".container2").offset();CANVAS_W=a.left;CANVAS_H=a.top;camera.aspect=WIDTH/HEIGHT;camera.updateProjectionMatrix();renderer.setSize(WIDTH,HEIGHT)}function getRandomInt(a,b){return Math.floor(Math.random()*(b-a+1))+a}
function initScene(){var a=WIDTH/HEIGHT;renderer=new THREE.WebGLRenderer({antialias:!0,logarithmicDepthBuffer:6E-4});camera=new THREE.PerspectiveCamera(45,a,.01,1E5);scene=new THREE.Scene;scene.name="scene_main";renderer.shadowMapEnabled=!0;renderer.shadowMapSoft=!0;camera.name="camera_main";scene.add(camera);camera.position.x=950;camera.position.y=1100;camera.position.z=0;camera.lookAt(new THREE.Vector3(0,-100,0));renderer.setSize(WIDTH,HEIGHT);renderer.setClearColor(16777215);renderer.domElement.id=
"canvas3d";$("#3dcontainer").html(renderer.domElement);renderer.domElement.toDataURL();a=new THREE.PointLight(16777215,.9);a.shadowDarkness=.6;a.name="point_lateral_light";scene.add(a);a.position.x=200;a.position.y=200;a.position.z=500;a=new THREE.Mesh(new THREE.PlaneGeometry(1E4,1E4,10,10),new THREE.MeshBasicMaterial({color:16777215}));a.rotation.x=-Math.PI/2;a.receiveShadow=!0;a.name="plane_shadow";scene.add(a);a=new THREE.DirectionalLight(16777215);a.position.set(-200,1E3,-300);a.castShadow=!0;
a.shadowMapWidth=2E3;a.shadowMapHeight=2E3;a.shadowCameraLeft=-1E3;a.shadowCameraRight=1E3;a.shadowCameraTop=1E3;a.shadowCameraBottom=-1E3;a.shadowCameraFar=2E3;a.shadowDarkness=.4;a.name="light_shadow";scene.add(a);controls=new THREE.OrbitControls(camera,renderer.domElement);controls.maxPolarAngle=Math.PI/2-.09;window.addEventListener("resize",onWindowResize,!1)}
if(0<$(".best-worst").length){var w;$(window).on("load",function(){$(".selectpicker").selectpicker();$("#slider-high").slider("setValue",hwc).on("slide",function(a){updateStats(Number(a.value.toFixed(1)))})})}
function updateStats(a){color_weight=hwc=a;height_weight=Number((1-hwc).toFixed(1));document.getElementById("val-dim-high").innerHTML=height_weight;document.getElementById("val-dim-color").innerHTML=color_weight;for(a=0;a<regionsort.length;a++)current_color=datasetC.data[a][color_prop],current_height=datasetH.data[a][height_prop],normalized_color=current_color/color_sum*100*color_weight*color_polarity,normalized_height=current_height/height_sum*100*height_weight*height_polarity,DEBUG&&(console.log("Normalized color indicator: "+
normalized_color),console.log("Normalized height indicator: "+normalized_height)),datasetH.data[a].rank=parseInt(100*(normalized_color+normalized_height)),current_rank=datasetH.data[a].rank;regionsort=jQuery.extend(!0,{},datasetH).data.sort(function(a,d){return a.rank>d.rank?-1:a.rank<d.rank?1:0});$("#region-b1").html(regionsort[0].nome_regione);$("#region-b2").html(regionsort[1].nome_regione);$("#region-b3").html(regionsort[2].nome_regione);$("#region-w3").html(regionsort[17].nome_regione);$("#region-w2").html(regionsort[18].nome_regione);
$("#region-w1").html(regionsort[19].nome_regione);updateShareText()}function chooseStat(a){var b=document.getElementById("statchooserH"),d=document.getElementById("statchooserC"),b=b.options[b.selectedIndex].value,d=d.options[d.selectedIndex].value;if(b==d)return console.log("turn error on: "+a.id),$("button[data-id="+a.id+"]").addClass("btn-danger"),!1;$(".btn-danger").removeClass("btn-danger");h=b;c=d;draw3DStat("regioni",h,c);updateShareText();return!0}
function updateShareText(){var a=document.getElementById("statchooserH"),b=document.getElementById("statchooserC");refURL=encodeURIComponent(location.protocol+"//"+location.host+location.pathname+"?l="+l+"&h="+h+"&c="+c+"&hwc="+hwc+"&g="+g);refText=encodeURIComponent("#ildatotratto "+a.options[a.selectedIndex].text+" & "+b.options[b.selectedIndex].text+" #istat #datachallenge");twurl="https://twitter.com/intent/tweet?tw_p=tweetbutton&url="+refURL+"&text="+refText;$("#twbutton").attr("href",twurl)}
function changeLang(a){l=a;hsel=document.getElementById("statchooserH");csel=document.getElementById("statchooserC");for(dsc=0;dsc<datasets.length;dsc++)hsel.options[dsc].text=datasets[dsc]["label_"+l],csel.options[dsc].text=datasets[dsc]["label_"+l];$(".selectpicker").selectpicker("refresh");document.title=labels["lbl_title_"+l];$("#titleselect").text(labels["lbl_titleselect_"+l]);$("#titleslider").text(labels["lbl_titleslider_"+l]);$("#titleshare").text(labels["lbl_titleshare_"+l]);$("#subtitle").html(labels["lbl_head_"+
l]);$("#aboutlink").attr("href","about_"+l+".html");$("#stat-dimhigh").html(hsel.options[hsel.selectedIndex].text);$(".label-dim-high").html(hsel.options[hsel.selectedIndex].text);$("#stat-dimcolor").html(csel.options[csel.selectedIndex].text);$(".label-dim-color").html(csel.options[csel.selectedIndex].text);updateShareText()};
